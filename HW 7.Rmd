---
title: "HW 7"
author: "Brandon Fenton and Allison Theobold"
date: "Due: October 27, 2016"
output:
  pdf_document:
    fig_height: 3
    fig_width: 5
  html_document:
    fig_width: 5
  word_document:
    fig_height: 3
    fig_width: 5
    
header-includes: \usepackage{float} \usepackage{bm} \usepackage{amsmath} \usepackage{amssymb} \usepackage{microtype}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(echo = FALSE)

library(grid)
library(gridExtra)
library(pander)
library(dplyr)
library(ggplot2)
library(effects)
library(ggfortify)
library(parallel)
library(mgcv)

panderOptions('missing', "-")

pander_lm <-function (fit, ...)
{
  fit.sum <- summary(fit)
  fit.coef <- fit.sum$coefficients
  fit.ttable <- matrix(nrow=length(fit.sum$aliased), ncol=4)
  colnames(fit.ttable) <- colnames(fit.sum$coefficients)
  rownames(fit.ttable) <- names(fit.sum$aliased)

  notna <- as.vector(which(!fit.sum$aliased))
  fit.ttable[notna,] <- fit.coef
  fit.ttable <- as.data.frame(fit.ttable)
  fit.ttable$`Pr(>|t|)` <- ifelse(fit.ttable$`Pr(>|t|)` < 0.0001, "<0.0001",
                                     sprintf("%.4f", fit.ttable$`Pr(>|t|)`))
  

  pander(fit.ttable, ...)
}

pander_anova <-function (fit, ...)
{
  fit.anova <- anova(fit)
  fit.anova$`Pr(>F)` <- ifelse(fit.anova$`Pr(>F)` < 0.0001, "<0.0001",
                                  sprintf("%.4f", fit.anova$`Pr(>F)`))

pander(fit.anova, ...)
}

clust <- makeCluster(detectCores())

# Set seeds for cores (runs will always be the same).
clusterSetRNGStream(clust, 1800)

```


Revisit your CO2 concentration time series from HW 4. If you want to switch groups from that assignment you can or you can work in the same ones. If you switch groups, pick a time series to analyze from those you worked with. Groups of up to 3. And just one time series per group.

1) We are going to be exploring a more complete model that includes a long-term trend and a seasonal component. We need to pick the type of trend and the form of the seasonal component. For the long term trend, consider the following options: no trend, linear trend, or quadratic trend. For the seasonal component, consider no seasonal component, seasonal means, single harmonic pair (m = 1), and 5th order harmonic (m = 5). Consider all combinations of these components, fit using `lm`.  Create a table that contains the model description, model used DF (so the count of free parameters), AICs, and $\Delta$AICs, sorting the table by AIcs. Use this information to discuss the top model selected (what was in it), the strength of support for that model versus the others, and the strength of evidence for a long-term trend and seasonal component (of the type selected) versus not including them in the model. 

  - You should be creating a table that contains twelve models.
```{r p1}
library(TSA)

BRW_flask<-tbl_df(read.table("BRW_flask.txt", header=T)) 

BRW_flask <- filter(BRW_flask, year>=1972)

BRW_flask <- BRW_flask %>% mutate(month = as.factor(month)) %>%
  mutate(year = as.vector(time(ts(BRW_flask$value,start=c(1972,1),freq=12))))

BRW_flask <- ts(BRW_flask, start = c(1972, 1), freq = 12)

# Models 1-3

ym_lm1 <- lm(value ~ 1, data = BRW_flask)
ym_lm2 <- lm(value ~ year, data = BRW_flask)
ym_lm3 <- lm(value ~ poly(year, 2), data = BRW_flask)

# Models 4-6
# no seasonal component is only a trend?
ym_lm4 <- lm(value ~ as.factor(month), data = BRW_flask) #seasonal means
ym_lm5 <- lm(value ~ harmonic(BRW_flask, m = 1), data = BRW_flask) 
ym_lm6 <- lm(value ~ harmonic(BRW_flask, m = 5), data = BRW_flask) 

## Trend with seasonality
ym_lm7 <- lm(value ~ year + as.factor(month), data = BRW_flask)
ym_lm8 <- lm(value ~ year + harmonic(BRW_flask, m = 1), data = BRW_flask)
ym_lm9 <- lm(value ~ year + harmonic(BRW_flask, m = 5), data = BRW_flask)

## Quadratic trend with seasonality
ym_lm10 <- lm(value ~ poly(year, 2) + as.factor(month), data = BRW_flask)
ym_lm11 <- lm(value ~ poly(year, 2) + harmonic(BRW_flask, m = 1), 
             data = BRW_flask)
ym_lm12 <- lm(value ~ poly(year, 2) + harmonic(BRW_flask, m = 5), 
             data = BRW_flask)

DF <- AIC <- rep(NA, 12)
for(i in 1:12){
  DF[i] <- 529 - summary(eval(as.name(paste("ym_lm", i, sep = ""))))$df[2]
  AIC[i] <- AIC(eval(as.name(paste("ym_lm", i, sep = ""))))
}

delta_AIC <- AIC - min(AIC)

table <- cbind(t(t(DF)), t(t(AIC)), t(t(delta_AIC)))
colnames(table) <- c("DF", "AIC", paste(expression(delta), "AIC"))
row.names(table) <- c("Int Only", "Year Trend", "Quadratic Year Trend", 
                      "Seasonal Means", "Single Harmonic", "5th Order Harmonic", 
                      "Year w/ Seasonal Means", "Year w/ Single Harmonic", 
                      "Year w/ 5th Order Harmonic", 
                      "Quadratic w/ Seasonal Means", 
                      "Quadratic w/ Single Harmonic", 
                      "Quadratic w/ 5th Order Harmonic")



pander(table)
```

In the table above, describing the fits of the 12 models considered, we see that the model including a quadratic for time, as well as a $5^{th}$ order harmonic fits "the best" according to AIC, however the AIC for the quadratic model with seasonal means is a difference of less than 2 from this "top model". There is strong evidence of the need for a quadratic trend component, as the quadratic models substantially outperform the linear trend models, according to AIC units. As for the seasonal component, there is no evidence of a difference between a model including seasonal means verses a $5^{th}$ order harmonic (after accounting for the quadratic trend). The model including a $5^{th}$ order harmonic does "fit better", but the interpretation of this model is far more challenging than a model which incorporates seasonal means. Therefore, in the interest of parsimony, from this model suite, the quadratic trend model with seasonal means should be chosen.   

2) Now fit a `gam` from the `mgcv` package that includes a long-term trend based on a thin-plate spline with shrinkage that uses `k = #years, bs = "ts"` from the fractional year variable and a cyclic spline seasonal component. To build the cyclic spline component, use the numerically coded month variable that goes from 1 to 12 and `k = 12,bs = "cc"`. Fit the model, plot the long-term trend and the seasonal component (use `plot(gam_model)`), and discuss the estimated components, using both the plots and the EDF of each term.

```{r p2}

ym_gam <- gam(value ~ s(time(BRW_flask), k=43, bs="ts")
                    + s(cycle(BRW_flask), k=12, bs="cc"), data=BRW_flask)

par(mfrow=c(1,2))
plot(ym_gam)
par(mfrow=c(1,1))
```

3) Calculate the AIC of the GAM using the `AIC` function and discuss how that result compares to your AICs in #1. How is it similar or different in terms of information (degrees of freedom) used?

```{r p3}
AIC(ym_gam)
```

4) Compare the fitted values of your GAM to those from your top model, plotting the two models's results and the responses vs time on the same plot.

```{r p4}
plot(BRW_flask[,4])
lines(fitted(ym_lm12) ~ as.vector(time(BRW_flask)), col="red")
lines(fitted(ym_gam) ~ as.vector(time(BRW_flask)), col="blue")
```

## A simulation study with autocorrelation present

5) Revisit your simulation with an AR(1) from HW 6 \# 10. Consider fitting a model with autocorrelation in it using `gls` from the `nlme` package that accounts for an MA(1) error and another that accounts for an AR(1) error. Run your simulation code, extracting the p-values from the two model summaries and estimate the type I error rate in each situation and compare it to what you get from the regular linear model. 

```{r p5}
```

- In a `gls` model summary, the estimates, SEs, test statistics, and p-values are contained in the `tTable` part of the summary. It has a similar layout to `coef` that we pulled the [2,4] element from to get the p-value from `lm`.

## Some derivation practice (these can be handwritten). If you have not completed STAT 421 or equivalent, please try the problem and then take advantage of advanced help by stopping by to chat about your answer. 

6) Answer Cryer and Chan question 2.4 (page 20)


7) Suppose that we are interested in the properties of a local average (linear filter) of two observations from an original time series, $x_t$. The new series is $y_t=(0.5)*(x_{t-1}+x_t)$. The mean of $x_t$ is 3, the variance of $x_t$ is 4, and the correlation between any neighboring $x_t$'s is 0.5 (so $cor(x_t, x_{t-1})=0.5$). $x_t$'s more than two time points apart are uncorrelated (correlation is 0). Use the rules for means and variances of linear combinations to find $E(y_t)$, $Var(y_t)$, and $Cov(y_t,y_{t-1})$. Do not worry about what happens at the edges of the time series (for t=1 or t=n), only worry about $t$ in general. 

  - Note that you have some preliminary work to complete to go from the provided information to what you need to work on the three derivations requested.
